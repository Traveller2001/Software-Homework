 # 2022软工K班个人编程任务

作业链接：[RJ6174/software-Engineering: 软件工程 (github.com)](https://github.com/RJ6174/software-Engineering)

**目录**

[一、PSP表格](#一、PSP表格)

[二、任务要求的实现](#二、任务要求的实现)

[利用xlwt模块将数据写入excel](#利用xlwt模块将数据写入excel)

[利用tkinter模块展示图形界面](#利用tkinter模块展示图形界面)

[利用matplotlib模块绘制饼状图](#利用matplotlib模块绘制饼状图)

[三、心得体会](#三、心得体会)

[四、附源码](#四、附源码)

------



# 一、PSP表格

| **PSP2.1**                              | **Personal Software** **Process Stages** | 预估耗时（分钟） | 实际耗时（分钟） |
| --------------------------------------- | ---------------------------------------- | ---------------- | ---------------- |
| Planning                                | 计划                                     | 60               | 60               |
| · Estimate                              | · 估计这个任务需要多少时间               | 10               | 15               |
| Development                             | 开发                                     | 2880             | 2600             |
| · Analysis                              | · 需求分析 (包括学习新技术)              | 360              | 400              |
| · Design Spec                           | · 生成设计文档                           | 90               | 100              |
| · Design Review                         | · 设计复审                               | 30               | 45               |
| · Coding Standard                       | · 代码规范 (为目前的开发制定合适的规范)  | 10               | 15               |
| · Design                                | · 具体设计                               | 120              | 150              |
| · Coding                                | · 具体编码                               | 1440             | 1500             |
| · Code Review                           | · 代码复审                               | 120              | 100              |
| · Test                                  | · 测试（自我测试，修改代码，提交修改）   | 120              | 150              |
| Reporting                               | 报告                                     | 120              | 90               |
| · Test Repor                            | · 测试报告                               | 30               | 30               |
| · Size Measurement                      | · 计算工作量                             | 30               | 40               |
| · Postmortem & Process Improvement Plan | · 事后总结, 并提出过程改进计划           | 30               | 50               |
|                                         | · 合计                                   | 5450             | 5345             |

# 二、任务要求的实现

> **项目设计与技术栈**。从阅读完题目到完成作业，这一次的任务被你拆分成了几个环节？你分别通过什么渠道、使用什么方式方法完成了各个环节？列出你完成本次任务所使用的技术栈。

| **序号** | **本次任务分为一下环节** | **通过...渠道完成**      |
| -------- | ------------------------ | ------------------------ |
| 1        | 项目规划                 | -                        |
| 2        | 爬虫与数据处理           | csdn、书、哔哩哔哩、抖音 |
| 3        | 数据写入Excel            | 哔哩哔哩、自己的代码库   |
| 4        | 绘制饼状图（可视化）     | csdn、慕课、百度         |
| 5        | GUI界面                  | 书                       |
| 6        | 测试与整理               | -                        |
| 7        | 博客                     | Typora、csdn             |

*本次任务中主要用到python、requests请求回复用于获取网页、xlwt在python中将数据写入excel表格、tkinter GUI界面、matplotliib用于实现数据可视化。*

------

> **爬虫与数据处理**。说明业务逻辑，简述代码的设计过程（例如可介绍有几个类，几个函数，他们之间的关系），并对关键的函数或算法进行说明。

- 在丁香医生官网获取url
- requests请求数据
- 请求页面 转化utf-8
- try { window.getAreaStat = (.*?)}catch\(e\) # 正则匹配
- 返回json数据
- 将json数据转化为字典形式数据返回

```python
def get_data_html():
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.1 (KHTML, like Gecko) Chrome/14.0.835.163 '
                      'Safari/535.1'}
    response = requests.get('https://ncov.dxy.cn/ncovh5/view/pneumonia?from=timeline&isappinstalled=0', headers=headers,
                            timeout=3)
    # 请求页面
    response = str(response.content, 'utf-8')
    # 中文重新编码
    return response
    # 返回了HTML数据

def get_data_dictype():
    areas_type_dic_raw = re.findall('try { window.getAreaStat = (.*?)}catch\(e\)', get_data_html())
    areas_type_dic = json.loads(areas_type_dic_raw[0])
    return areas_type_dic  # 返回经过json转换过的字典化的数据
```

![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)

爬取结果如下所示：

![img](https://img-blog.csdnimg.cn/7e1ea4c82340492f825c64378d0b07b8.png)![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)编辑

------

> **数据统计接口部分的性能改进**。记录在数据统计接口的性能上所花费的时间，描述你改进的思路，并展示一张性能分析图（例如可通过VS 2019/JProfiler的性能分析工具自动生成），并展示你程序中消耗最大的函数。

​    数据统计接口，主要时间都花费在对爬取的底层数据接口分析，网站每天都会定期更新数据，导致爬取的底层数据格式会有些许变化，周而复始的分心接口，分析时间段10：00-23：00，因为只有这个时段底层接口不会改变。

![img](https://img-blog.csdnimg.cn/e74954b491c745e5bdd4a5538acc7b1f.gif)![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)编辑

------

> **每日热点的实现思路**。简要介绍实现该功能的算法原理，可给出必要的步骤流程图、数学公式推导和核心代码实现，并简要谈谈所采用算法的优缺点与可能的改进方案。

![img](https://img-blog.csdnimg.cn/8607675422ce41aab01acd035b079630.png)![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)编辑

------

​    热点实现思路，热点发现算法本质上说是数据挖掘上的聚类算法。通过将预处理后的文本信息，归入不同的话题，并根据需要建立新话题，话题聚类的质量与算法本身和算法中设置的参数阈值密切相关。常用的聚类算法有Single pass算法、KNN聚合分类算法、支持向量机算法、K-means算法、SOM神经网络聚类算法。

​    以上算法都有各自的优缺点，需要综合使用，发挥各自的长处，避免各自的短处。

![img](https://img-blog.csdnimg.cn/img_convert/07fe5c4d2105a083294f51a3a983ebfc.jpeg)

![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)编辑

------

> **数据可视化界面的展示**。在博客中介绍数据可视化界面的组件和设计的思路。

- ### 利用xlwt模块将数据写入excel

1. 导入xlwt模块
2. 创建工作薄
3. 创建工作表
4. 对于单元格样式及格式的设置（可选）
5. 写入数据(加上对于样式格式的设置)
6. 保存execl文件

------

![img](https://img-blog.csdnimg.cn/70d74da5542543fd90ca397545315413.png) 各省数据展示

![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)编辑

------

![img](https://img-blog.csdnimg.cn/241ca78787344006a82fd2404c9625be.png) 福建省数据展示

![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)编辑

------

- ### 利用tkinter模块展示图形界面

1. 导入 tkinter 模块
2. 创建 GUI 根窗体
3. 添加人机交互控件并编写相应的函数。
4. 在主事件循环中等待用户触发事件响应。

------

![img](https://img-blog.csdnimg.cn/7c18a1e635264ef6b1c0a277771d6b44.png) GUI界面

![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)编辑

------

- ### 利用matplotlib模块绘制饼状图

1. 将各省的累计确诊人数数据另取出来，排序找到前五名较多人数省份生成饼状图并保存在文件夹中 
2. 在函数save_data_to_excle中向label列表中顺序添加中国省份名称，向vvalues列表中顺序添加各省累计确诊人数。
3. 字典z中Label当键，vvalues当值，然后按值逆序排序，之后取前五个。 最后利用matplotlib.pyplot中的pie()绘制，title（）设置标题，savefig()保存图片，show（）展示图片。列表切片取前五个。

------

![img](https://img-blog.csdnimg.cn/53359da08cb94e91bfb4e2866cbdfb46.png) 累计确诊前5饼状图

![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)

------

# 三、心得体会

> 在这儿写下你完成本次作业的心得体会，当然，如果你还有想表达的东西但在上面两个板块没有体现，也可以写在这儿~

​    看完题目的第一反应：难难难！什么都不会，就两周时间，要从哪里开始......显而易见都说现在是数据时代，数据才是王道，没有数据什么也做不了。那就先开始爬取数据吧，正在学爬虫的我，已经要开始实践了，上网找的代码看不懂，不会修改，只能每天没日没夜的刷视频学爬虫，之后开始一步一步跟着视频实践，听说卫健委的反爬机制比较复杂，无意间找到丁香医生网站那里只有一部分数据，之后与腾讯数据做融合......
​     通过对中国疫情数据的爬取与处理，我学习到了一些有关数据爬取、处理、分析、可视化的方法。 但收获也颇多，虽然曾经接触过pyhton，主要懂得基础语法，并没有教学爬虫相关的内容。总之，没有压力就没有动力。即使再小的帆也能远航。

# 四、附源码

```python
import requests
import os
import re
import xlwt
import time
import json
import matplotlib.pyplot as plt
import tkinter
from tkinter import ttk
from tkinter import *

"""
********************************爬取数据********************************
# 网址：https://ncov.dxy.cn/ncovh5/view/pneumonia?from=timeline&isappinstalled=0
# get_data_dictype() 返回的数据是一个列表
# 列表中的每个元素都是一个字典，即每个列表元素都是一个省的总疫情数据
# 每个字典的provinceName是省份名称，currentConfirmedCount是本省现存确诊人数，confirmedCount是本省累计确诊人数等等
# 每个字典cities键的值是一个列表，这个列表的每个元素是字典，包含一个地区的疫情数据
"""


def get_data_html():
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.1 (KHTML, like Gecko) Chrome/14.0.835.163 '
                      'Safari/535.1'}
    response = requests.get('https://ncov.dxy.cn/ncovh5/view/pneumonia?from=timeline&isappinstalled=0', headers=headers,
                            timeout=3)
    # 请求页面
    response = str(response.content, 'utf-8')
    # 中文重新编码
    return response
    # 返回了HTML数据


def get_data_dictype():
    areas_type_dic_raw = re.findall('try { window.getAreaStat = (.*?)}catch\(e\)', get_data_html())
    areas_type_dic = json.loads(areas_type_dic_raw[0])
    print(areas_type_dic)
    return areas_type_dic  # 返回经过json转换过的字典化的数据


"""
********************************确定及创建项目保存路径********************************
若文件保存目录不存在，则创建此目录并输出显示“数据文件夹不存在”及创建保存的目录。数据保存成功则输出显示数据爬取成功
"""


def make_dir():  # 检查并创建数据目录
    file_path = 'E:/Python/Program_SE/中国疫情情况采集/'
    if not os.path.exists(file_path):
        print('数据文件夹不存在')
        os.makedirs(file_path)
        print('数据文件夹创建成功,创建目录为%s' % file_path)
    else:
        print('数据保存在目录：%s' % file_path)


"""
********************************数据写入Excel********************************
创建多个工作表。第一个工作表命名为“中国各省”,里面包含各省的新冠肺炎疫情情况
（总现存确诊人数，总累计确诊人数，总疑似人数，总治愈人数，总死亡人数，地区ID编码）。
后面的工作表依次按读取到的省份命名，工作表里面包含的数据为某省具体地区的疫情情况
（现存确诊人数，累计确诊人数，疑似人数，治愈人数，死亡人数，地区ID编码），
第二行是这个省的总情况，且与本省地区情况之间空一行，方便观察
"""


def createxcelsheet(workbook, name):
    worksheet = workbook.add_sheet(name, cell_overwrite_ok=True)
    for i in range(0, 9):
        worksheet.col(i).width = 256 * 15
    al = xlwt.Alignment()
    al.horz = 0x02  # 设置水平居中
    style = xlwt.XFStyle()
    style.alignment = al
    # 写入数据列标签
    worksheet.write(0, 0, '城市名称', style)
    worksheet.write(0, 1, '现存确诊人数', style)
    worksheet.write(0, 2, '累计确诊人数', style)
    worksheet.write(0, 3, '疑似人数', style)
    worksheet.write(0, 4, '治愈人数', style)
    worksheet.write(0, 5, '死亡人数', style)
    worksheet.write(0, 6, '今日新增确诊', style)
    worksheet.write(0, 7, '今日新增无症状', style)
    worksheet.write(0, 8, '地区ID编码', style)
    return worksheet, style


global label, vvalues  # 获得中国省份名称和累计确诊人数
label = []
vvalues = []


def save_data_to_excle():  # 爬取数据并保存在Excel中
    make_dir()  # 调用方法检查数据目录是否存在，不存在则创建数据文件夹
    newworkbook = xlwt.Workbook()  # 打开工作簿，创建工作表
    sheet, style = createxcelsheet(newworkbook, '中国各省')
    count = 1  # 中国各省的计数器
    for province_data in get_data_dictype():
        c_count = 1  # 某省的计数器
        provincename = province_data['provinceName']
        provinceshortName = province_data['provinceShortName']
        p_currentconfirmedCount = province_data['currentConfirmedCount']
        p_confirmedcount = province_data['confirmedCount']
        p_suspectedcount = province_data['suspectedCount']
        p_curedcount = province_data['curedCount']
        p_deadcount = province_data['deadCount']
        p_locationid = province_data['locationId']
        # 用循环获取省级以及该省以下城市的数据
        label.append(provincename)

        vvalues.append(p_confirmedcount)
        sheet.write(count, 0, provincename, style)
        sheet.write(count, 1, p_currentconfirmedCount, style)
        sheet.write(count, 2, p_confirmedcount, style)
        sheet.write(count, 3, p_suspectedcount, style)
        sheet.write(count, 4, p_curedcount, style)
        sheet.write(count, 5, p_deadcount, style)
        sheet.write(count, 8, p_locationid, style)
        count += 1
        worksheet, style = createxcelsheet(newworkbook, provincename)
        worksheet.write(c_count, 0, provinceshortName, style)
        worksheet.write(c_count, 1, p_currentconfirmedCount, style)
        worksheet.write(c_count, 2, p_confirmedcount, style)
        worksheet.write(c_count, 3, p_suspectedcount, style)
        worksheet.write(c_count, 4, p_curedcount, style)
        worksheet.write(c_count, 5, p_deadcount, style)
        worksheet.write(c_count, 8, p_locationid, style)
        # 在工作表里写入省级数据
        c_count += 2  # 省与省下各城市之间空一行

        for citiy_data in province_data['cities']:
            # 该部分获取某个省下某城市的数据
            cityname = citiy_data['cityName']
            c_currentconfirmedCount = citiy_data['currentConfirmedCount']
            c_confirmedcount = citiy_data['confirmedCount']
            c_suspectedcount = citiy_data['suspectedCount']
            c_curedcount = citiy_data['curedCount']
            c_deadcount = citiy_data['deadCount']
            c_locationid = citiy_data['locationId']
            # 向Excel对应列标写入数据
            worksheet.write(c_count, 0, cityname, style)
            worksheet.write(c_count, 1, c_currentconfirmedCount, style)
            worksheet.write(c_count, 2, c_confirmedcount, style)
            worksheet.write(c_count, 3, c_suspectedcount, style)
            worksheet.write(c_count, 4, c_curedcount, style)
            worksheet.write(c_count, 5, c_deadcount, style)
            worksheet.write(c_count, 8, c_locationid, style)
            c_count += 1  # 此处为写入行数累加，在cities部分循环

    current_time = time.strftime("%Y年%m月%d日%H：%M：%S", time.localtime())
    newworkbook.save('E:/Python/Program_SE/中国疫情情况采集/实时采集-%s.xls' % current_time)
    print('******数据爬取成功******')


"""
********************************绘制饼状图********************************
# 将各省的累计确诊人数数据另取出来，排序找到前五名较多人数省份生成饼状图并保存在文件夹中
在函数save_data_to_excle中向label列表中顺序添加中国省份名称，向vvalues列表中顺序添加各省累计确诊人数。
字典z中Label当键，vvalues当值，然后按值逆序排序，之后取前五个。
最后利用matplotlib.pyplot中的pie()绘制，title（）设置标题，savefig()保存图片，show（）展示图片。列表切片取前五个。
"""


def sjvisual():
    plt.rcParams['font.sans-serif'] = ['SimHei']  # 解决中文显示问题
    plt.rcParams['axes.unicode_minus'] = False  # 解决负号显示问题
    plt.figure(figsize=(7, 6))

    z = zip(label, vvalues)
    s = sorted(z, key=lambda x: x[1], reverse=True)
    top5 = s[0:5:]
    labels = (dict(top5)).keys()
    values = (dict(top5)).values()
    plt.pie(values, labels=labels, radius=1.2, pctdistance=0.8, autopct='%1.2f%%')  # 绘制饼图
    plt.savefig('E:/Python/Program_SE/中国疫情情况采集/2022年中国疫情确诊人数前五省饼图.png')  # 保存图片
    plt.title('国内前5个累计确诊人数比例')
    plt.show()  # 展示图片


"""
********************************GUI界面********************************
GUI界面可查询中国某省总疫情情况和此省下地区的具体疫情情况。
通过下拉列表框选择想要查询的省份，若想查询此省下某地区疫情情况，可点击对应地区按钮进行查询。
若想查询多个省份，查完一个省份后可在下拉列表框中再次选择想要查询的省份，某省下地区疫情情况点击相应按钮即可。
"""


def GUI():  # 制作GUI界面
    global win
    win = tkinter.Tk()  # 构造窗体
    win.minsize(800, 660)
    win.title('中国各省疫情情况查询')
    tkinter.Label(win, text='请选择省份：', height=1, width=10).place(x=200, y=0)
    tkinter.Label(win, text='省份：').place(x=240, y=40)
    tkinter.Label(win, text='现存确诊人数：').place(x=240, y=70)
    tkinter.Label(win, text='累计确诊人数：').place(x=240, y=100)
    tkinter.Label(win, text='疑似人数：').place(x=240, y=130)
    tkinter.Label(win, text='治愈人数：').place(x=240, y=160)
    tkinter.Label(win, text='死亡人数：').place(x=240, y=190)

    global comboxlist  # 将下拉列表框定义为全局变量，便于在go（）中匹配对应数据
    comvalue = tkinter.StringVar()  # 窗体自带的文本，新建一个值
    comboxlist = ttk.Combobox(win, textvariable=comvalue)  # 初始化
    comboxlist["values"] = label
    comboxlist.current(0)  # 选择第一个显示
    # 下拉列表框绑定go函数，则有省份被选中时，执行go函数
    comboxlist.bind("<<ComboboxSelected>>", go)  # 绑定事件,(下拉列表框被选中时，绑定go()函数)
    comboxlist.pack()
    win.mainloop()  # 进入消息循环


global tst
tst = []


def go(*args):  # 处理事件，*args表示可变参数
    for i in tst:  # 清空上个被选择省份的地区信息
        i.place_forget()
    c = comboxlist.get()  # 被选中的省份
    for province_data in get_data_dictype():
        provincename = province_data['provinceName']
        if c == provincename:
            tkinter.Label(win, text=provincename, height=1, width=15).place(x=400, y=40)
            tkinter.Label(win, text=province_data['currentConfirmedCount'], height=1, width=10).place(x=400, y=70)
            tkinter.Label(win, text=province_data['confirmedCount'], height=1, width=10).place(x=400, y=100)
            tkinter.Label(win, text=province_data['suspectedCount'], height=1, width=10).place(x=400, y=130)
            tkinter.Label(win, text=province_data['curedCount'], height=1, width=10).place(x=400, y=160)
            tkinter.Label(win, text=province_data['deadCount'], height=1, width=10).place(x=400, y=190)
            tkinter.Label(win, text='\t请选择' + provincename + '下地区：', height=1, width=20).place(x=50, y=220)
            # 设置城市按钮的位置
            lt = [(15, 240), (115, 240), (215, 240), (315, 240), (415, 240), (515, 240), (615, 240), (715, 240),
                  (15, 280), (115, 280), (215, 280), (315, 280), (415, 280), (515, 280), (615, 280), (715, 280),
                  (15, 320), (115, 320), (215, 320), (315, 320), (415, 320), (515, 320), (615, 320), (715, 320),
                  (15, 360), (115, 360), (215, 360), (315, 360), (415, 360), (515, 360), (615, 360), (715, 360),
                  (15, 400), (115, 400), (215, 400), (315, 400), (415, 400), (515, 400), (615, 400), (715, 400)]
            ct = 0  # 按钮位置计数器
            for city_data in province_data['cities']:
                while ct < len(province_data['cities']):
                    b = Button(win, text=city_data['cityName'], height=1, width=10)
                    tst.append(b)  # 装入按钮，便于清除
                    b.place(x=lt[ct][0], y=lt[ct][1])
                    b.bind('<Button-1>', show)  # 当按钮被选中，绑定show函数
                    ct += 1
                    break  # 控制一个城市只建一次按钮
                tkinter.Label(win, text='地区：').place(x=240, y=435)
                tkinter.Label(win, text='现存确诊人数：').place(x=240, y=465)
                tkinter.Label(win, text='累计确诊人数：').place(x=240, y=495)
                tkinter.Label(win, text='疑似人数：').place(x=240, y=525)
                tkinter.Label(win, text='治愈人数：').place(x=240, y=555)
                tkinter.Label(win, text='死亡人数：').place(x=240, y=585)


def show(event):  # 显示对应城市数据
    # comboxlist.get()从下拉列表框得到被选中的省份名称，即想要查询的省份
    c = comboxlist.get()  # 获得被选中城市（按钮）名称
    for province_data in get_data_dictype():
        provincename = province_data['provinceName']
        if c == provincename:
            for city_data in province_data['cities']:
                # event.widget[‘text’]能得到被点击按钮的名字，即想要查询的省下地区
                if city_data['cityName'] == event.widget['text']:  # 匹配到对应数据
                    tkinter.Label(win, text=city_data['cityName'], height=1, width=15).place(x=400, y=435)
                    tkinter.Label(win, text=city_data['currentConfirmedCount'], height=1, width=15).place(x=400, y=465)
                    tkinter.Label(win, text=city_data['confirmedCount'], height=1, width=15).place(x=400, y=495)
                    tkinter.Label(win, text=city_data['suspectedCount'], height=1, width=15).place(x=400, y=525)
                    tkinter.Label(win, text=city_data['curedCount'], height=1, width=15).place(x=400, y=555)
                    tkinter.Label(win, text=city_data['deadCount'], height=1, width=15).place(x=400, y=585)


save_data_to_excle()
sjvisual()
GUI()
```

![点击并拖拽以移动](C:\Users\Administrator.DESKTOP-QNQUK2E\Desktop\点击并拖拽以移动.gif)
